{
    "version": "https://jsonfeed.org/version/1",
    "title": "tdcq'Blog • All posts by \"contos\" tag",
    "description": "记录自己技术博文",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2021/04/08/fastDFS%E5%AE%89%E8%A3%85/",
            "url": "http://example.com/2021/04/08/fastDFS%E5%AE%89%E8%A3%85/",
            "title": "基于CentOS7安装fastDFS",
            "date_published": "2021-04-08T08:03:02.000Z",
            "content_html": "<p><font color=\"#E96B03\" size=\"2\" face=\"黑体\">fastDFS</font>是以 C 语言开发的一项开源轻量级分布式文件系统，他对文件进行管理，主要功能有：文件存储，文件同步，文件访问（文件上传 / 下载）, 特别适合以文件为载体的在线服务，如图片网站，视频网站等。</p>\n<blockquote>\n<p>适用范围</p>\n</blockquote>\n<ul>\n<li>含有<font color=\"#E96B03\" size=\"2\" face=\"黑体\">文件上传</font>功能的应用</li>\n<li>含有<font color=\"#E96B03\" size=\"2\" face=\"黑体\">文件下载</font>功能的应用</li>\n<li><font color=\"#E96B03\" size=\"2\" face=\"黑体\">分布式</font>应用（不在一台服务器上）</li>\n<li>上传结果：<font color=\"#E96B03\" size=\"2\" face=\"黑体\">/group1/M00/00/00/CmQCyl_EY2eAGDp1AACK3ZiQsLg494.png<br>\n</font></li>\n<li>支持<font color=\"#E96B03\" size=\"2\" face=\"黑体\">分布式存储</font></li>\n</ul>\n<h2 id=\"docker方式安装\"><a class=\"markdownIt-Anchor\" href=\"#docker方式安装\">#</a> Docker 方式安装</h2>\n<blockquote>\n<p>下载镜像</p>\n</blockquote>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nginx\"><span class=\"hljs-attribute\">docker</span> pull delron/fastdfs<br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>查看本地仓库</p>\n</blockquote>\n<figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ebnf\"><span class=\"hljs-attribute\">docker images</span><br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>开启端口</p>\n</blockquote>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">firewall-cmd <span class=\"hljs-attribute\">--zone</span>=public  --permanent <span class=\"hljs-attribute\">--add-port</span>=8888/tcp<br>firewall-cmd <span class=\"hljs-attribute\">--zone</span>=public  --permanent <span class=\"hljs-attribute\">--add-port</span>=22122/tcp<br>firewall-cmd <span class=\"hljs-attribute\">--zone</span>=public  --permanent <span class=\"hljs-attribute\">--add-port</span>=23000/tcp<br></code></pre></td></tr></table></figure>\n<ul>\n<li>8888 http 访问端口</li>\n<li>22122 tracker 端口</li>\n<li>23000 storage 端口</li>\n</ul>\n<blockquote>\n<p>刷新端口</p>\n</blockquote>\n<figure class=\"highlight ada\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ada\">firewall-cmd <span class=\"hljs-comment\">--reload</span><br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>查看端口</p>\n</blockquote>\n<figure class=\"highlight brainfuck\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs brainfuck\"><span class=\"hljs-comment\">firewall</span><span class=\"hljs-literal\">-</span><span class=\"hljs-comment\">cmd</span> --<span class=\"hljs-comment\">zone=public</span> --<span class=\"hljs-comment\">list</span><span class=\"hljs-literal\">-</span><span class=\"hljs-comment\">ports</span><br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>创建 tracker 容器</p>\n</blockquote>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">docker run -dti --network=host --name tracker -v <span class=\"hljs-regexp\">/data/</span>fastDfs<span class=\"hljs-regexp\">/tracker:/</span>var<span class=\"hljs-regexp\">/fdfs -v /</span>etc<span class=\"hljs-regexp\">/localtime:/</span>etc<span class=\"hljs-regexp\">/localtime delron/</span>fastdfs tracker<br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>容器开机自启</p>\n</blockquote>\n<figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">docker <span class=\"hljs-keyword\">update</span> <span class=\"hljs-comment\">--restart=always tracker</span><br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>增加 storage 可写权限</p>\n</blockquote>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">mkdir -p <span class=\"hljs-regexp\">/data/</span>fastDfs<span class=\"hljs-regexp\">/storage/</span>logs<br><br>chmod <span class=\"hljs-number\">777</span> <span class=\"hljs-regexp\">/data/</span>fastDfs<span class=\"hljs-regexp\">/storage/</span>logs<br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>创建 storage 容器</p>\n</blockquote>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">docker run -dti --network=host --name storage -e TRACKER_SERVER=`<span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">211.200</span>`:<span class=\"hljs-number\">22122</span> -v <span class=\"hljs-regexp\">/data/</span>fastDfs<span class=\"hljs-regexp\">/storage:/</span>var<span class=\"hljs-regexp\">/fdfs  -v /</span>etc<span class=\"hljs-regexp\">/localtime:/</span>etc<span class=\"hljs-regexp\">/localtime  delron/</span>fastdfs storage<br></code></pre></td></tr></table></figure>\n<p>其中<font color=\"#E96B03\" size=\"2\" face=\"黑体\"> 192.168.211.200</font>为内网 ip，需要修改</p>\n<blockquote>\n<p>容器开机自启</p>\n</blockquote>\n<figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">docker <span class=\"hljs-keyword\">update</span> <span class=\"hljs-comment\">--restart=always storage</span><br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>测试</p>\n</blockquote>\n<ul>\n<li>测试成功后，说明上传已经可以了</li>\n</ul>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-comment\">## 进入容器</span><br>docker exec -it storage bash<br><br><span class=\"hljs-comment\">## 设置nginx</span><br>cd <span class=\"hljs-regexp\">/usr/</span>local<span class=\"hljs-regexp\">/nginx/</span>conf<br>vi nginx.conf<br><br><span class=\"hljs-comment\">## 测试上传</span><br>cd <span class=\"hljs-regexp\">/etc/</span>fdfs<br>echo hello=fuck&gt;a.txt<br><span class=\"hljs-comment\">## 上传</span><br><span class=\"hljs-regexp\">/usr/</span>bin<span class=\"hljs-regexp\">/fdfs_upload_file /</span>etc<span class=\"hljs-regexp\">/fdfs/</span>client.conf a.txt<br><br><span class=\"hljs-comment\">## 上传结果</span><br>group1<span class=\"hljs-regexp\">/M00/</span><span class=\"hljs-number\">00</span><span class=\"hljs-regexp\">/00/</span>wKjTyF9SW9qAejgfAAAAC9k-OCU699.txt<br><br><span class=\"hljs-comment\">## 重启storage</span><br>docker restart storage<br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>nginx 配置</p>\n</blockquote>\n<ul>\n<li>记得开启<font color=\"#E96B03\" size=\"2\" face=\"黑体\">22122</font>对外端口权限，否则外网无法上传文件</li>\n<li>一般情况下，文件上传只在<font color=\"#E96B03\" size=\"2\" face=\"黑体\">服务器内部</font>进行</li>\n<li>最后需要配置 Nginx 配置，用来接收外网的访问</li>\n</ul>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nginx\"><span class=\"hljs-attribute\">location</span> /group[<span class=\"hljs-number\">0</span>-<span class=\"hljs-number\">9</span>]/M00 &#123;<br>    <span class=\"hljs-comment\">## ip+端口为dfs内网ip+端口</span><br>    <span class=\"hljs-attribute\">proxy_pass</span>  http://10.100.2.130:8888;<br>    <span class=\"hljs-comment\">## 这里配置，可以自定义下载重命名</span><br>    <span class=\"hljs-attribute\">if</span> ($arg_attname <span class=\"hljs-regexp\">~* \\.(doc|docx|pdf|zip|rar|txt|jar)$)</span> &#123;<br>        <span class=\"hljs-attribute\">add_header</span> Content-Disposition <span class=\"hljs-string\">&quot;attachment;filename=$arg_attname&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n",
            "tags": [
                "contos"
            ]
        }
    ]
}